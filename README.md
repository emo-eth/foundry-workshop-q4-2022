# Foundry: Beyond Fuzzing
(Very much a work in progress)

Foundry is a suite of (currently) three tools: Forge, Cast, and Anvil. 

Many introductory Foundry guides and workshops cover the basics of writing tests in Solidity and the basics of Fuzzing, and the benefits of both. You can find an excellent example [here](https://github.com/dabit3/foundry-workshop). 

This workshop is meant to be a more nuanced guide to Foundry, and will cover the following topics:

- Foundry CLI tools & the commands you should know and leverage
- Relevant fundamentals for advanced techniques
  - EVM fundamentals and quirks
  - HEVM fundamentals and quirks
  - Foundry configuration
- Scripting with Forge
- Advanced testing techniques with `forge-std` and knowledge of EVM fundamentals

# Where to find Documentation and Information

The [Foundry Book](https://book.getfoundry.sh/) is an excellent source of information, but it isn't always up-to-date. New features sneak their way in that can take time to be documented, or else are more "preview" features and thus subject to change. 

Furthermore, by default (currently), `foundryup` uses the latest _nightly_ build of Foundry, which can occasionally break things. 

If I run into something that doesn't work as expected or is undocumented, I'll usually check the [Github Issues page](https://github.com/foundry-rs/foundry/issues) first.

The [Pull Requests page](https://github.com/foundry-rs/foundry/pulls) is also a great source of information.

If those fail, I'll sometimes dig into the source code. As of writing, Invariant testing is not documented, but digging through the source you can find how to configure them in [the relevant code](https://github.com/foundry-rs/foundry/blob/master/evm/src/fuzz/invariant/executor.rs).

It also helps to know Foundry's history: Foundry was inspired by [Dapptools](https://github.com/dapphub/dapptools), and while Foundry has a good number of features Dapptools never had, certain features are still catching up to Dapptools' capabilities, like [invariant testing](https://github.com/dapphub/dapptools/tree/master/src/dapp#invariant-testing) (in a "preview" stage) and [symbolic execution](https://github.com/dapphub/dapptools/tree/master/src/dapp#symbolically-executed-tests) (on the roadmap, but has not been started).

In cases where a legacy Dapptools feature is not documented well in Foundry (which is admittedly infrequent these days), you might be able to find some extra information in the Dapptools documentation. 



# Foundry CLI Tools

Foundry's CLI tools are well-documented and full of features. `forge` and `cast` probably have easy ways for doing _multiple_ things you've struggled with in the past.

Take a minute and dig through the output of `forge -h` and `cast -h`. You'll find a lot of useful information.

I'll emphasize the ones I think are under-utilized, or have non-obvious use-cases (as of November 2022).


## Forge 


- `forge config` - show current values for all configuration variables
- `forge fmt` - Format your Solidity code (configurably via `foundry.toml` with [these options](https://book.getfoundry.sh/reference/config/formatter))
  - Select `foundry` as the default formatter in VSCode!
- `forge init` - initialize a new Forge project
  - `forge init --force (--no-commit)` - initialize Forge in an existing non-Foundry project
- `forge remappings` - List automatically generated remappings from submodules and `node_mdules` if present
  - `forge remappings > remappings.txt` - save remappings to a file so VSCode is happy
- `forge inspect` - get information about a smart contract, worth a `forge inspect -h` in its own right
  - `forge inspect <contract> storage` - get the storage layout of a contract
  - `forge inspect <contract> ir` - get the Yul intermediate-representation source code generated by the Solidity compiler, as done by the `--via-ir` pipeline - which you can use to inform [how to write your code for bytecode optimization](https://twitter.com/z0age/status/1578443864217554945)
- `forge snapshot` - generate a gas snapshot of test cases
  - can configure IR to reject tests that exceed a certain gas change with `--tolerance` option
- `forge tree` - see visualization of dependency tree for files in your project
- `forge coverage` - in its infancy, but still useful
  - `forge coverage --report lcov` - generate lcov report for use with [codecov.io](https://codecov.io/)
  - `forge coverage --report lcov && genhtml lcov.info -o html --branch` to generate HTML report
  - Still unable to generate coverage reports for things like constructors and some assembly keywords, see [this issue](https://github.com/foundry-rs/foundry/issues/1961)
- `forge upload-selectors` - upload the 4-byte  function, error, and event signatures to the [function selector database](https://sig.eth.samczsun.com)


## Cast

- `cast 4byte 0xdeadbeef` - get the function signature for a 4-byte selector
- `cast 4byte-decode 0xdeadbeef000000...` - decode calldata into a function signature and its arguments
- `cast pretty-calldata <calldata>` - decode calldata into a function signature and each 32-byte word passed as arguments
- `cast call <address> <sig> <args>` - perform a STATICCALL to an account
- `cast send <address> <sig> <args>` - perform a CALL to an account
- `cast publish` - publish raw transaction
- `cast calldata <sig> <args>` - generate calldata for a function call
- `cast etherscan-source <address>` - pull the source code for a verified contract from Etherscan
- `cast run <tx hash>` - run a published transaction
  - `cast run <tx hash> --debug` - run a published transaction in debug mode
  - Try it with this phishing tx hash: `0x63f665d2ee14fda67a2a65d132ba013e0dbffdc192a4ad2bfaf9527edcce6fa6`
- `cast storage <address> <slot>` - read a contract's storage slot
- `cast resolve-name <ens name>` - lookup address associated with ENS name
- `cast interface <path or verified contract address>` - generate solidity interface from ABI
- `cast --to-dec <hex value>` - convert hex value to decimal
- `cast --to-hex <dec value>` - convert decimal value to hex
  
# Relevant Fundamentals


### EVM Fundamentals
- **Solidity is not the EVM**
- Storage layout
- Memory layout
- Calls and reverts

### HEVM Fundamentals
- What is HEVM?
- Cheatcodes
- Assertions


### Foundry Configuration
- `forge config` - show values of current values for all config variables
- overlap with `vm.config`

# Scripting with Forge
- Reading and writing data from chain
  - `forge script script/WritingData.s.sol --fork-url $ETH_RPC_URL -vvvv`
- Simulating transactions
- Deploying Contracts
- Deploying with SafeCreate2
- Scripting with assertions
  - `forge script script/WithArguments.s.sol --sig "run(uint256,address)" 100 $(cast resolve-name emo.eth) -vvv`

# Advanced Testing Techniques

- Fork testing
- Mocking calls and contracts
- `ffi`
- [stdStorage](https://github.com/foundry-rs/forge-std/blob/master/src/StdStorage.sol)
- [Invariant Testing](https://github.com/maple-labs/revenue-distribution-token/tree/add-forge-invariants/contracts/test)
- [Differential Testing](https://github.com/ProjectOpenSea/seaport/blob/main/test/foundry/utils/DifferentialTest.sol)
- [Wrangling multiple solidity versions and profile configs](https://github.com/ProjectOpenSea/seaport/blob/main/foundry.toml)
